
name: Build OCTA NETWORK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          npm ls

      - name: Configure build environment
        run: |
          echo "ðŸš€ ØªÙƒÙˆÙŠÙ† Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù„Ù€ OCTA NETWORK"
          echo "GITHUB_REPOSITORY=${{ github.repository }}" >> $GITHUB_ENV
          echo "NODE_ENV=production" >> $GITHUB_ENV
          echo "VITE_APP_VERSION=4.0.0" >> $GITHUB_ENV
          echo "VITE_APP_NAME=OCTA NETWORK" >> $GITHUB_ENV
          echo "VITE_BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          
          # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ©
          if [[ "${{ github.repository }}" =~ ^[^/]+/[^/]+$ ]]; then
            REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
            echo "VITE_BASE_URL=/${REPO_NAME}/" >> $GITHUB_ENV
            echo "REPO_NAME=${REPO_NAME}" >> $GITHUB_ENV
          else
            echo "VITE_BASE_URL=/" >> $GITHUB_ENV
          fi

      - name: Build application
        run: |
          echo "ðŸ—ï¸ Ø¨Ù†Ø§Ø¡ OCTA NETWORK..."
          npm run build
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¨Ù†Ø§Ø¡
          if [ -d "dist" ] && [ -f "dist/index.html" ]; then
            echo "âœ… ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­"
            ls -la dist/
          else
            echo "âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¨Ù†Ø§Ø¡"
            exit 1
          fi
        env:
          NODE_ENV: production
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Optimize build output
        run: |
          echo "ðŸ”§ ØªØ­Ø³ÙŠÙ† Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙˆØ§ÙÙ‚
          touch ./dist/.nojekyll
          
          # ØªØ­Ø³ÙŠÙ† index.html Ù„Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø³Ø¨ÙŠØ©
          if [ ! -z "$REPO_NAME" ]; then
            echo "ðŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù„Ù€ GitHub Pages..."
            sed -i 's|="/|="/'$REPO_NAME'/|g' ./dist/index.html
            sed -i 's|href="/|href="/'$REPO_NAME'/|g' ./dist/index.html
            sed -i 's|src="/|src="/'$REPO_NAME'/|g' ./dist/index.html
          fi
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù robots.txt
          cat > ./dist/robots.txt << 'EOF'
          User-agent: *
          Allow: /
          
          Sitemap: /sitemap.xml
          EOF
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù manifest.json
          cat > ./dist/manifest.json << 'EOF'
          {
            "name": "OCTA NETWORK",
            "short_name": "OCTA",
            "description": "Ù…Ù†ØµØ© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ø°ÙƒÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#667eea",
            "theme_color": "#667eea",
            "icons": [
              {
                "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EðŸŒ%3C/text%3E%3C/svg%3E",
                "sizes": "192x192",
                "type": "image/svg+xml"
              }
            ]
          }
          EOF

      - name: Run build validation
        run: |
          echo "ðŸ§ª ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡..."
          
          # ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
          REQUIRED_FILES=("index.html" "manifest.json" "robots.txt" ".nojekyll")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "dist/$file" ]; then
              echo "âœ… $file Ù…ÙˆØ¬ÙˆØ¯"
            else
              echo "âŒ $file Ù…ÙÙ‚ÙˆØ¯"
              exit 1
            fi
          done
          
          # ÙØ­Øµ Ø­Ø¬Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡
          BUILD_SIZE=$(du -sh dist/ | cut -f1)
          echo "ðŸ“¦ Ø­Ø¬Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡: $BUILD_SIZE"
          
          # ÙØ­Øµ Ù…Ù„ÙØ§Øª JS Ùˆ CSS
          JS_COUNT=$(find dist/ -name "*.js" | wc -l)
          CSS_COUNT=$(find dist/ -name "*.css" | wc -l)
          echo "ðŸ“„ Ù…Ù„ÙØ§Øª JS: $JS_COUNT"
          echo "ðŸŽ¨ Ù…Ù„ÙØ§Øª CSS: $CSS_COUNT"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: octa-network-build-node${{ matrix.node-version }}
          path: ./dist
          retention-days: 7
          compression-level: 6

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-node${{ matrix.node-version }}
          path: |
            npm-debug.log*
            yarn-debug.log*
            yarn-error.log*
          retention-days: 3

  security-scan:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run security audit
        run: |
          echo "ðŸ”’ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†..."
          npm audit --audit-level moderate || true
          
      - name: Check for vulnerabilities
        run: |
          echo "ðŸ›¡ï¸ ÙØ­Øµ Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©..."
          npx audit-ci --moderate || true
